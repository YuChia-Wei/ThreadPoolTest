### **檔案上傳 I/O 效能瓶頸分析與改善作法報告**

**日期:** 2025-07-04

#### **1. 問題分析**

根據 k6 效能測試結果，即使在預先設定或使用預設執行緒集區的情況下，Raw Streaming 上傳 API 的 P95 請求延遲時間仍高達 26-27 秒，遠超 3 秒的預期目標。此現象強烈表明，系統的瓶頸並非 CPU 運算能力或執行緒數量不足，而是出在 **I/O 處理能力**上。在高併發情境下，後端服務無法及時將傳入的檔案串流寫入儲存裝置，導致請求大量阻塞，延遲急遽升高。

本報告旨在提出一系列可行的改善方案，以擴充系統的 I/O 能力，解決此效能瓶頸。

---

#### **2. 改善方案**

以下方案依據實作難易度與預期效益排序，建議由上而下依序嘗試。

##### **方案一：程式碼層級優化 (立即行動)**

此方案專注於以最低成本、最快速度改善現有檔案寫入邏輯，是應對問題的第一步。

**作法：優化 `FileStream` 的使用方式**

在 `ThreadsPoolTest.UseCases/Files/Services/FileService.cs` 中，修改建立 `FileStream` 的方式，以提升磁碟寫入效率。

1.  **增加緩衝區大小 (Buffer Size):** 將 `FileStream` 的預設緩衝區（通常為 4KB）加大。較大的緩衝區可以在記憶體中累積更多資料後，再一次性寫入磁碟，有效減少昂貴的 I/O 操作次數。
2.  **啟用非同步 I/O (`useAsync: true`):** 明確以非同步模式開啟檔案流，使其能與 C# 的 `async/await` 機制完美配合，避免執行緒在等待磁碟 I/O 時被卡住，從而可以去處理其他請求。

**建議程式碼修改 (`FileService.cs`):**

```csharp
// 優化前的寫法可能為：
// await using var fileStream = new FileStream(filePath, FileMode.Create);

// 優化後的建議寫法：
await using var fileStream = new FileStream(
    filePath,
    FileMode.Create,          // 模式
    FileAccess.Write,         // 權限
    FileShare.None,           // 分享模式
    bufferSize: 81920,        // 設定一個較大的緩衝區，例如 80KB
    useAsync: true);          // 明確啟用非同步 I/O

// 將請求串流非同步地複製到檔案串流
await requestStream.CopyToAsync(fileStream);
```

---

##### **方案二：架構層級優化 (中期計畫)**

若程式碼層級的優化效果有限，則需從架構面徹底改變請求處理流程，以分散 I/O 壓力。

**作法：實作「寫入與處理分離」模式**

將 API 的職責最小化，使其只負責最快速的「接收並寫入暫存區」，後續的慢速操作則交由背景工作處理。

1.  **建立高速暫存區 (Landing Zone):** API 端點接收到檔案串流後，立即將其寫入一個高速的本地儲存位置（例如 NVMe SSD），完成後馬上回傳 `200 OK` 給使用者。
2.  **引入背景工作佇列 (Background Job Queue):** 檔案寫入暫存區後，API 發送一個「任務」到背景佇列。可使用 .NET 內建的 `IHostedService` 搭配 `Channel<T>` 實作，或引入如 `Hangfire`、`Quartz.NET` 等成熟的函式庫。
3.  **非同步處理後續任務:** 由獨立的背景工作執行緒從佇列中取出任務，並執行耗時的後續操作，例如：
    *   病毒掃描、檔案驗證
    *   圖片壓縮、格式轉換
    *   將檔案從暫存區搬移至最終的永久儲存體（如網路磁碟、雲端儲存）

**優點:**
*   **極低的 API 延遲:** 使用者上傳體驗極佳。
*   **高吞吐量與高可用性:** API 不會被慢速 I/O 拖垮，系統更穩定。

---

##### **方案三：基礎設施層級優化**

當應用程式與架構都已優化，但仍有效能瓶頸時，可考慮從硬體或外部服務著手。

1.  **升級硬體:** 將伺服器的儲存裝置從傳統 HDD 升級為企業級 SSD 或 NVMe SSD，能帶來最直接的 I/O 效能提升。
2.  **整合專門的儲存服務:** 直接將檔案串流至專為大流量設計的雲端儲存服務（如 Azure Blob Storage, Amazon S3）。這些服務的 SDK 提供了高度優化的串流上傳方法，能將 I/O 壓力完全轉移至雲端供應商的基礎設施上。

#### **3. 建議行動方案**

1.  **立即執行:** 採納【方案一】，修改 `FileService.cs` 中的 `FileStream` 建立方式，並立即重新進行 k6 壓力測試，以評估效能改善幅度。
2.  **規劃導入:** 若方案一改善效果未達預期，應立即規劃並導入【方案二】的架構重構，這是解決此類高併發 I/O 問題最根本、最可靠的作法。
